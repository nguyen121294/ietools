<!DOCTYPE html>
<html lang="vi" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valhalla Distance Matrix - H∆∞·ªõng d·∫´n C√†i ƒë·∫∑t & S·ª≠ d·ª•ng</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"]
                    }
                }
            }
        }
    </script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <!-- HEADER -->
    <div id="header-placeholder"></div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <div class="ie-page-header">
            <h1 class="ie-page-title">Valhalla Distance Matrix Local</h1>
            <p class="ie-page-description">
                H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t v√† ch·∫°y c√¥ng c·ª• t√≠nh kho·∫£ng c√°ch OSM tr√™n m√°y c√° nh√¢n (chi ti·∫øt t·ª´ng b∆∞·ªõc).
            </p>
        </div>

        <div class="ie-main-grid">

            <!-- 1. PREREQUISITES -->
            <div class="ie-card lg:col-span-3">
                <h2 class="ie-card-title">1. Y√™u c·∫ßu & Ki·ªÉm tra M√¥i tr∆∞·ªùng</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-primary mb-2">Ph·∫ßn c·ª©ng</h3>
                        <ul class="list-disc list-inside text-slate-300 space-y-1 text-sm">
                            <li>RAM: T·ªëi thi·ªÉu 4GB (Khuy·∫øn ngh·ªã 8GB)</li>
                            <li>Disk: T·ªëi thi·ªÉu 10GB tr·ªëng (·ªï D:)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-primary mb-2">Ki·ªÉm tra Docker</h3>
                        <p class="text-sm text-slate-400 mb-2">M·ªü <strong>CMD</strong> (Command Prompt) v√† ch·∫°y l·ªánh sau
                            ƒë·ªÉ ch·∫Øc ch·∫Øn Docker ƒë√£ c√†i:</p>
                        <div class="ie-formula text-xs mb-2">
                            docker --version
                        </div>
                        <p class="text-xs text-slate-500 italic">
                            K·∫øt qu·∫£ c·∫ßn hi·ªán version (vd: Docker version 20.10...). N·∫øu l·ªói, h√£y c√†i Docker Desktop
                            tr∆∞·ªõc.
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. SETUP -->
            <div class="ie-card lg:col-span-3">
                <h2 class="ie-card-title">2. Thi·∫øt l·∫≠p D·ªØ li·ªáu (Setup)</h2>
                <p class="text-slate-400 mb-4 text-sm">
                    Th·ª±c hi·ªán ch√≠nh x√°c c√°c b∆∞·ªõc sau ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu v√† build server.
                </p>

                <div class="space-y-6">
                    <!-- Step 2.1: Folder -->
                    <div>
                        <h3 class="text-white font-semibold flex items-center gap-2 mb-2">
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded">B∆Ø·ªöC 1</span>
                            T·∫°o th∆∞ m·ª•c & Copy File Map
                        </h3>
                        <div class="bg-slate-900 p-4 rounded border border-slate-700 space-y-3">
                            <p class="text-sm text-slate-300">
                                1. V√†o ·ªï <strong>D:\</strong> t·∫°o th∆∞ m·ª•c t√™n: <code
                                    class="text-white">valhalla-distance-matrix</code><br>
                                2. Trong ƒë√≥, t·∫°o th√™m th∆∞ m·ª•c con t√™n: <code class="text-white">data</code><br>
                                3. T·∫£i file b·∫£n ƒë·ªì (PBF) v√† copy v√†o th∆∞ m·ª•c <code>data</code>.
                            </p>
                            <div class="ie-formula text-xs">
                                D:\valhalla-distance-matrix\data\vietnam-latest.osm.pbf
                            </div>
                        </div>
                    </div>

                    <!-- Step 2.2: Commands -->
                    <div>
                        <h3 class="text-white font-semibold flex items-center gap-2 mb-2">
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded">B∆Ø·ªöC 2</span>
                            Ch·∫°y l·ªánh Build (Setup)
                        </h3>
                        <p class="text-sm text-slate-400 mb-3">
                            M·ªü <strong>CMD</strong>, ch·∫°y l·∫ßn l∆∞·ª£t <strong>3 l·ªánh</strong> sau (copy v√† paste t·ª´ng
                            l·ªánh):
                        </p>

                        <div class="space-y-4">
                            <!-- Command 1 -->
                            <div>
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">L·ªánh 1: T·∫°o Config</p>
                                <div
                                    class="ie-formula overflow-x-auto text-xs break-all select-all cursor-text text-green-400 p-3">
                                    docker run --rm -v "D:\valhalla-distance-matrix\data:/data"
                                    ghcr.io/valhalla/valhalla:latest valhalla_build_config --mjolnir-tile-dir
                                    /data/valhalla_tiles --mjolnir-tile-extract /data/valhalla_tiles.tar
                                    --mjolnir-timezone /data/valhalla_tiles/timezones.sqlite --mjolnir-admin
                                    /data/valhalla_tiles/admins.sqlite >
                                    "D:\valhalla-distance-matrix\data\valhalla.json"
                                </div>
                            </div>

                            <!-- Command 2 -->
                            <div>
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">L·ªánh 2: Build Tiles (T·ªën v√†i
                                    ph√∫t)</p>
                                <div
                                    class="ie-formula overflow-x-auto text-xs break-all select-all cursor-text text-green-400 p-3">
                                    docker run -t --rm -v "D:\valhalla-distance-matrix\data:/data"
                                    ghcr.io/valhalla/valhalla:latest valhalla_build_tiles -c /data/valhalla.json
                                    /data/vietnam-latest.osm.pbf --overwrite
                                </div>
                            </div>

                            <!-- Command 3 -->
                            <div>
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">L·ªánh 3: ƒê√≥ng g√≥i (Extract)
                                </p>
                                <div
                                    class="ie-formula overflow-x-auto text-xs break-all select-all cursor-text text-green-400 p-3">
                                    docker run -t --rm -v "D:\valhalla-distance-matrix\data:/data"
                                    ghcr.io/valhalla/valhalla:latest valhalla_build_extract -c /data/valhalla.json
                                    --overwrite
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. DEPLOY -->
            <div class="ie-card lg:col-span-3">
                <h2 class="ie-card-title">3. Kh·ªüi ch·∫°y ·ª®ng d·ª•ng (Deploy)</h2>
                <div class="space-y-8">

                    <!-- 3.1 Python Code -->
                    <div>
                        <h3 class="text-white font-semibold flex items-center gap-2 mb-2">
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded">B∆Ø·ªöC 1</span>
                            T·∫°o file App Code
                        </h3>
                        <p class="text-sm text-slate-400 mb-3">
                            T·∫°o file t√™n <code>app.py</code> t·∫°i <code>D:\valhalla-distance-matrix\</code> v√† copy to√†n
                            b·ªô n·ªôi dung code d∆∞·ªõi ƒë√¢y v√†o:
                        </p>

                        <textarea
                            class="ie-input w-full h-96 font-mono text-xs text-slate-300 bg-slate-900 border-slate-700 focus:border-primary"
                            readonly onclick="this.select()">
import streamlit as st
import requests
import json
import pandas as pd

# C·∫•u h√¨nh URL c·ªßa Valhalla (ƒë·∫£m b·∫£o Docker ƒëang ch·∫°y)
VALHALLA_URL = "http://localhost:8002/sources_to_targets"

st.set_page_config(page_title="Valhalla Distance Matrix", layout="wide")

st.title("üöÄ Valhalla Local Distance Matrix")
st.markdown("Nh·∫≠p t·ªça ƒë·ªô ƒë·ªÉ t√≠nh to√°n ma tr·∫≠n kho·∫£ng c√°ch t·ª´ d·ªØ li·ªáu OSM n·ªôi b·ªô.")

col1, col2 = st.columns(2)

with col1:
    st.subheader("üìç ƒêi·ªÉm b·∫Øt ƒë·∫ßu (Sources)")
    sources_input = st.text_area(
        "Nh·∫≠p Lat, Lon (m·ªói d√≤ng m·ªôt ƒëi·ªÉm)", 
        "21.0285, 105.8542",
        help="V√≠ d·ª•: 21.0285, 105.8542",
        key="sources"
    )

with col2:
    st.subheader("üéØ ƒêi·ªÉm k·∫øt th√∫c (Targets)")
    targets_input = st.text_area(
        "Nh·∫≠p Lat, Lon (m·ªói d√≤ng m·ªôt ƒëi·ªÉm)", 
        "21.0368, 105.8346\n21.0245, 105.8412",
        help="V√≠ d·ª•: 21.0368, 105.8346",
        key="targets"
    )

def parse_coords(text):
    coords = []
    for line in text.strip().split('\n'):
        if ',' in line:
            lat, lon = line.split(',')
            coords.append({"lat": float(lat.strip()), "lon": float(lon.strip())})
    return coords

if st.button("‚ö° T√≠nh to√°n Ma tr·∫≠n"):
    try:
        sources = parse_coords(sources_input)
        targets = parse_coords(targets_input)
        
        # T·∫°o payload theo chu·∫©n Valhalla
        payload = {
            "sources": sources,
            "targets": targets,
            "costing": "auto",
            "units": "kilometers"
        }

        # G·ª≠i request ƒë·∫øn Docker Valhalla
        with st.spinner('ƒêang t√≠nh to√°n l·ªô tr√¨nh...'):
            response = requests.post(VALHALLA_URL, json=payload)
            response.raise_for_status()
            data = response.json()

        results = []
        for i, row in enumerate(data['sources_to_targets']):
            for j, matrix_item in enumerate(row):
                # L·∫•y gi√° tr·ªã an to√†n, n·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ l√† None
                dist = matrix_item.get('distance')
                time_sec = matrix_item.get('time')

                results.append({
                    "T·ª´ ƒëi·ªÉm (Index)": matrix_item['from_index'],
                    "ƒê·∫øn ƒëi·ªÉm (Index)": matrix_item['to_index'],
                    "Kho·∫£ng c√°ch (km)": round(dist, 2) if dist is not None else "N/A",
                    "Th·ªùi gian (ph√∫t)": round(time_sec / 60, 2) if time_sec is not None else "N/A"
                })

        df = pd.DataFrame(results)
        st.success("‚úÖ ƒê√£ t√≠nh to√°n xong!")
        st.dataframe(df, use_container_width=True)
        
        # Cho ph√©p t·∫£i v·ªÅ CSV
        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button("üì• T·∫£i v·ªÅ k·∫øt qu·∫£ CSV", csv, "distance_matrix.csv", "text/csv")

    except Exception as e:
        st.error(f"‚ùå L·ªói: {e}")
        st.info("üí° H√£y ƒë·∫£m b·∫£o Docker Valhalla ƒëang ch·∫°y t·∫°i http://localhost:8002")
                    </textarea>
                        <p class="text-xs text-center text-slate-500 mt-2">
                            (Nh·∫•n v√†o code ƒë·ªÉ b√¥i ƒëen to√†n b·ªô, sau ƒë√≥ Ctrl+C ƒë·ªÉ copy)
                        </p>
                    </div>

                    <!-- 3.2 Run Server -->
                    <div>
                        <h3 class="text-white font-semibold flex items-center gap-2 mb-2">
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded">B∆Ø·ªöC 2</span>
                            B·∫≠t Valhalla Server
                        </h3>
                        <p class="text-sm text-slate-400 mb-3">
                            M·ªü CMD v√† ch·∫°y l·ªánh sau (l∆∞u √Ω: c·ª≠a s·ªï n√†y c·∫ßn gi·ªØ nguy√™n, kh√¥ng t·∫Øt):
                        </p>
                        <div
                            class="ie-formula overflow-x-auto text-xs break-all select-all cursor-text text-green-400 p-3">
                            docker run -i --name valhalla-server -p 8002:8002 -v
                            "D:\valhalla-distance-matrix\data:/data" ghcr.io/valhalla/valhalla:latest valhalla_service
                            /data/valhalla.json 1
                        </div>
                    </div>

                    <!-- 3.3 Run App -->
                    <div>
                        <h3 class="text-white font-semibold flex items-center gap-2 mb-2">
                            <span class="bg-primary text-white text-xs px-2 py-0.5 rounded">B∆Ø·ªöC 3</span>
                            Ch·∫°y ·ª®ng d·ª•ng
                        </h3>
                        <p class="text-sm text-slate-400 mb-3">
                            M·ªü th√™m m·ªôt c·ª≠a s·ªï <strong>CMD M·ªõi</strong>, v√† g√µ l·∫ßn l∆∞·ª£t 3 l·ªánh sau:
                        </p>
                        <div class="space-y-2">
                            <div class="ie-formula text-xs text-green-400 font-bold p-2">D:</div>
                            <div class="ie-formula text-xs text-green-400 font-bold p-2">cd valhalla-distance-matrix
                            </div>
                            <div class="ie-formula text-xs text-green-400 font-bold p-2">streamlit run app.py</div>
                        </div>

                        <div class="mt-4 p-3 bg-blue-900/20 border border-blue-800 rounded">
                            <p class="text-xs text-blue-200 text-center">
                                N·∫øu th√†nh c√¥ng, tr√¨nh duy·ªát s·∫Ω t·ª± m·ªü ƒë∆∞·ªùng d·∫´n <strong>http://localhost:8501</strong>
                            </p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 4. USAGE -->
            <div class="ie-card lg:col-span-3">
                <h2 class="ie-card-title">4. H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng App</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

                    <!-- Input -->
                    <div class="space-y-3">
                        <h3 class="text-white font-semibold border-b border-slate-700 pb-2">1. Nh·∫≠p T·ªça ƒê·ªô</h3>
                        <p class="text-sm text-slate-400">
                            Nh·∫≠p danh s√°ch t·ªça ƒë·ªô (Lat, Lon) v√†o hai √¥ Sources v√† Targets.
                        </p>
                        <div class="ie-formula text-xs">
                            21.0285, 105.8542<br>
                            21.0368, 105.8346
                        </div>
                    </div>

                    <!-- Process -->
                    <div class="space-y-3">
                        <h3 class="text-white font-semibold border-b border-slate-700 pb-2">2. X·ª≠ L√Ω</h3>
                        <p class="text-sm text-slate-400">
                            Nh·∫•n n√∫t <strong>"T√≠nh to√°n Ma tr·∫≠n"</strong>. App s·∫Ω g·ªçi API t·ªõi Local Valhalla.
                        </p>
                        <div class="p-3 bg-slate-900 rounded border border-slate-700">
                            <code class="text-xs text-green-400">
                            POST /sources_to_targets<br>
                            ...
                        </code>
                        </div>
                    </div>

                    <!-- Output -->
                    <div class="space-y-3">
                        <h3 class="text-white font-semibold border-b border-slate-700 pb-2">3. K·∫øt Qu·∫£</h3>
                        <p class="text-sm text-slate-400">
                            Xem k·∫øt qu·∫£ Km v√† Th·ªùi gian tr√™n b·∫£ng. T·∫£i v·ªÅ CSV n·∫øu c·∫ßn.
                        </p>
                    </div>

                </div>
            </div>

        </div>

    </main>

    <!-- FOOTER -->
    <div id="ie-footer"></div>

    <script src="/js/layout.js"></script>

</body>

</html>